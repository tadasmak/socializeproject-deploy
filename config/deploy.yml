# Backend Rails API Configuration
service: socialize_project
image: tadasmak/socialize_project_backend

servers:
  web:
    hosts:
      - 91.98.71.82
  worker:
    hosts:
      - 91.98.71.82
    cmd: bundle exec sidekiq

registry:
  username: tadasmak
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64
  dockerfile: backend/Dockerfile.backend
  context: .
  args:
    CONTEXT_PATH: backend

proxy:
  ssl: false
  app_port: 3000
  hosts:
    - socializeproject.com
    - www.socializeproject.com
  path_prefix: '/api'
  strip_path_prefix: false
  healthcheck:
    path: /up
    interval: 5
    timeout: 10

deploy_timeout: 60
drain_timeout: 30
readiness_delay: 15

env:
  secret:
    - RAILS_MASTER_KEY
    - POSTGRES_PASSWORD
  clear:
    RAILS_ENV: production
    RACK_ENV: production
    RAILS_LOG_TO_STDOUT: "1"
    DB_HOST: "socialize_project-postgres"
    POSTGRES_USER: postgres
    POSTGRES_DB: socialize_project_production
    REDIS_URL: "redis://socialize_project-redis:6379/1"

ssh:
  user: root

accessories:
  postgres:
    image: postgres:15
    host: 91.98.71.82
    port: 5432
    env:
      clear:
        POSTGRES_DB: socialize_project_production
        POSTGRES_USER: postgres
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
  redis:
    image: redis:7
    host: 91.98.71.82
    port: 6379
    directories:
      - data:/data

# service: socialize_project

# servers:
#   web:
#     hosts:
#       - 91.98.71.82
#     labels:
#       traefik.http.routers.backend.rule: "Host(`91.98.71.82`) && PathPrefix(`/api`)"

# image: tadasmak/socialize_project_backend

# registry:
#   username: tadasmak
#   password:
#     - KAMAL_REGISTRY_PASSWORD

# proxy:
#   ssl: false
#   host: 91.98.71.82
#   healthcheck:
#     path: /health # The path to check on your app
#     interval: 10 # How often to check
#     timeout: 5 # How long to wait for a response

# env:
#   secret:
#     - RAILS_MASTER_KEY
#     - SECRET_KEY_BASE
#     - POSTGRES_PASSWORD
#   clear:
#     RAILS_ENV: production
#     SOLID_QUEUE_IN_PUMA: "false"
#     DB_HOST: socialize_project-db
#     DB_NAME: socialize_project_production
#     DB_USER: postgres
#     WEB_CONCURRENCY: 2
#     RAILS_MAX_THREADS: 5

# builder:
#   arch: amd64
#   cache:
#     type: registry
#   context: ./backend
#   dockerfile: backend/Dockerfile.backend

# accessories:
#   frontend:
#     image: tadasmak/socialize_project_frontend
#     host: 91.98.71.82
#     port: 8080:80

#   db:
#     image: postgres:15
#     host: 91.98.71.82
#     env:
#       clear:
#         POSTGRES_DB: socialize_project_production
#         POSTGRES_USER: postgres
#         RAILS_ENV: production
#       secret:
#         - POSTGRES_PASSWORD
#     directories:
#       - data:/var/lib/postgresql/data
#     port: 5432

# volumes:
#   - "socialize_project_storage:/rails/storage"

# aliases:
#   console: app exec --interactive --reuse "bin/rails console"
#   shell: app exec --interactive --reuse "bash"
#   logs: app logs -f
#   dbc: app exec --interactive --reuse "bin/rails dbconsole"